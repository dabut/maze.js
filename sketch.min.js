function setup(){frameRate(100),pixelDensity(displayDensity()),createCanvas(windowWidth,windowHeight),initialize()}function draw(){noStroke(),fill(0,0,0),rect(0,0,cols*s+1,rows*s+1);for(var a=0;a<visited.length;a++)visit(grid[visited[a]]);for(var b=0;b<canGoTo.length;b++)for(var a=0;a<canGoTo[b].length;a++)goTo(grid[canGoTo[b][a]]);for(var a=0;a<winner.length;a++)win(winner[a]);for(var c=0;c<cpf/stacks;c++)for(var b=0;b<current.length;b++)if(void 0!=current[b]){if(current[b].group=b,current[b].visited=!0,highlight(current[b]),visited.includes(index(current[b].i,current[b].j))||visited.push(index(current[b].i,current[b].j)),canGoTo[b].includes(index(current[b].i,current[b].j))||canGoTo[b].push(index(current[b].i,current[b].j)),current[b]==grid[rows*cols-1])for(var a=0;a<stack[b].length;a++)winner.push(stack[b]);var d=checkNeighbours(current[b],b);if(void 0!=d)stack[b].push(current[b]),d.visited=!0,d.group===-1&&(d.group=b),visited.includes(index(d.i,d.j))||visited.push(index(d.i,d.j)),canGoTo[b].includes(index(d.i,d.j))||canGoTo[b].push(index(d.i,d.j)),removeWalls(current[b],d),current[b]=d;else{var e=canGoTo[b].indexOf(index(current[b].i,current[b].j));e>-1&&canGoTo[b].splice(e,1),current[b]=stack[b].pop()}circleBranch&&(current[b]=grid[canGoTo[b][Math.floor(Math.random()*canGoTo[b].length)]])}else cont[b]=!1;for(var a=0;a<grid.length;a++)show(grid[a]);if(!cont.includes(!0)){link(),clear(),noStroke(),fill(0,0,0),rect(0,0,cols*s+1,rows*s+1);for(var a=0;a<visited.length;a++)visit(grid[visited[a]]);for(var a=0;a<winner.length;a++)win(winner[a]);for(var a=0;a<grid.length;a++)show(grid[a]);noLoop()}}function initialize(){cols=floor((width-1)/s),rows=floor((height-1)/s),grid=[],visited=[],canGoTo=[];for(var a=0;a<rows;a++)for(var b=0;b<cols;b++){var c=new Cell(b,a);grid.push(c)}stacks=Math.min(floor(cols*rows/9),worms),current=[],stack=[],winner=[],friends=[],cont=[];for(var d=0;d<stacks;d++){canGoTo[d]=[],cont[d]=!0;do{room=!1;var e=floor(Math.random()*cols),f=floor(Math.random()*rows);for(b=e-1;b<=e+1;b++)for(a=f-1;a<=f+1;a++)current.includes(grid[index(b,a)])&&(room=!0)}while(room);current[d]=grid[index(e,f)],stack[d]=[]}}function create(){initialize(),loop()}function index(a,b){return infinite&&(a=(a%cols+cols)%cols,b=(b%rows+rows)%rows),a<0||b<0||a>cols-1||b>rows-1?-1:a+b*cols}function removeWalls(a,b){var c=a.i-b.i;1===c||c===-cols+1?(a.walls[3]=!1,b.walls[1]=!1):c!==-1&&c!==cols-1||(a.walls[1]=!1,b.walls[3]=!1);var d=a.j-b.j;1===d||d===-rows+1?(a.walls[0]=!1,b.walls[2]=!1):d!==-1&&d!==rows-1||(a.walls[2]=!1,b.walls[0]=!1)}function checkNeighbours(a,b){var c=[];i=a.i,j=a.j;var d=grid[index(i,j-1)],e=grid[index(i+1,j)],f=grid[index(i,j+1)],g=grid[index(i-1,j)];if(d&&!d.visited&&c.push(d),e&&!e.visited&&c.push(e),f&&!f.visited&&c.push(f),g&&!g.visited&&c.push(g),c.length>0){var h=floor(Math.random()*c.length);return c[h]}}function show(a){i=a.i,j=a.j,walls=a.walls;var b=i*s,c=j*s;stroke(255),strokeWeight(1),walls[0]&&line(b,c,b+s,c),walls[1]&&line(b+s,c,b+s,c+s),walls[2]&&line(b+s,c+s,b,c+s),walls[3]&&line(b,c+s,b,c)}function link(){for(var a=[],b=[0],c=0;c<grid.length;c++){var d=grid[c];i=d.i,j=d.j;var e=grid[index(i,j-1)],f=grid[index(i+1,j)],g=grid[index(i,j+1)],h=grid[index(i-1,j)];e&&e.group!==d.group&&a.push([d,e]),f&&f.group!==d.gorup&&a.push([d,f]),g&&g.group!==d.group&&a.push([d,g]),h&&h.group!==d.group&&a.push([d,h])}for(;b.length<stacks;){do var k=a[floor(Math.random()*a.length)];while(!b.includes(k[0].group)||b.includes(k[1].group));b.push(k[1].group),removeWalls(k[0],k[1])}}function highlight(a){fill(255,0,255),rect(a.i*s,a.j*s,s,s)}function visit(a){fill(127,0,127),rect(a.i*s,a.j*s,s,s)}function goTo(a){fill(0,127,127),rect(a.i*s,a.j*s,s,s)}function win(a){fill(0,159,0),rect(a.i*s,a.j*s,s,s)}Math.seedrandom("seed");var s=10,cpf=1e3,worms=100,infinite=!0,circleBranch=!1;